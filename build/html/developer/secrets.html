

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Secrets &mdash; buildbot-translate 0.0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> buildbot-translate
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorial/index.html">1. Buildbot Tutorial</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">buildbot-translate</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Secrets</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/developer/secrets.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="secrets">
<h1>Secrets<a class="headerlink" href="#secrets" title="Permalink to this headline">¶</a></h1>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SecretDetails</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ...</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</pre></div>
</div>
<p>A <code class="docutils literal notranslate"><span class="pre">secretDetails</span></code> is a python object initialized with a provider name, a key and a value.
Each parameter is an object property.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">secretdetail</span> <span class="o">=</span> <span class="n">SecretDetails</span><span class="p">(</span><span class="s2">&quot;SourceProvider&quot;</span><span class="p">,</span> <span class="s2">&quot;myKey&quot;</span><span class="p">,</span> <span class="s2">&quot;myValue&quot;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">secretdetail</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
<span class="s2">&quot;SourceProvider&quot;</span>
<span class="k">print</span><span class="p">(</span><span class="n">secretdetail</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
<span class="s2">&quot;myKey&quot;</span>
<span class="k">print</span><span class="p">(</span><span class="n">secretdetail</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<span class="s2">&quot;myValue&quot;</span>
</pre></div>
</div>
<p>A Secret is defined by a key associated to a value, returned from a provider.
Secrets returned by providers are stored in a <code class="docutils literal notranslate"><span class="pre">secretDetails</span></code> object.</p>
</div>
<div class="section" id="secrets-manager">
<h1>Secrets manager<a class="headerlink" href="#secrets-manager" title="Permalink to this headline">¶</a></h1>
<p>The manager is a Buildbot service manager.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">secretsService</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">namedServices</span><span class="p">[</span><span class="s1">&#39;secrets&#39;</span><span class="p">]</span>
<span class="n">secretDetailsList</span> <span class="o">=</span> <span class="n">secretsService</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">secrets</span><span class="p">)</span>
</pre></div>
</div>
<p>The service executes a get method.
Depending on the kind of storage chosen and declared in the configuration, the manager gets the selected provider and returns a list of <code class="docutils literal notranslate"><span class="pre">secretDetails</span></code>.</p>
</div>
<div class="section" id="secrets-providers">
<h1>Secrets providers<a class="headerlink" href="#secrets-providers" title="Permalink to this headline">¶</a></h1>
<p>The secrets providers are implementing the specific getters, related to the storage chosen.</p>
<div class="section" id="file-provider">
<h2>File provider<a class="headerlink" href="#file-provider" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;secretsProviders&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">secrets</span><span class="o">.</span><span class="n">SecretInAFile</span><span class="p">(</span><span class="n">dirname</span><span class="o">=</span><span class="s2">&quot;/path/toSecretsFiles&quot;</span><span class="p">)]</span>
</pre></div>
</div>
<p>In the master configuration the provider is instantiated through a Buildbot service secret manager with the file directory path.
File secrets provider reads the file named by the key wanted by Buildbot and returns the contained text value (removing trailing newlines if present).
SecretInAFile provider allows Buildbot to read secrets in the secret directory.</p>
</div>
<div class="section" id="vault-provider">
<h2>Vault provider<a class="headerlink" href="#vault-provider" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;secretsProviders&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">secrets</span><span class="o">.</span><span class="n">SecretInVault</span><span class="p">(</span><span class="n">vaultToken</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="s1">&#39;VAULT_TOKEN&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span>
                                            <span class="n">vaultServer</span><span class="o">=</span><span class="s2">&quot;http://localhost:8200&quot;</span><span class="p">,</span>
                                            <span class="n">apiVersion</span><span class="o">=</span><span class="mi">2</span><span class="p">)]</span>
</pre></div>
</div>
<p>In the master configuration, the provider is instantiated through a Buildbot service secret manager with the Vault token and the Vault server address.
Vault secrets provider accesses the Vault backend asking the key wanted by Buildbot and returns the contained text value.
SecretInVAult provider allows Buildbot to read secrets in the Vault.
Currently only v1 and v2 of the Key-Value backends are supported.</p>
</div>
<div class="section" id="interpolate-secret">
<h2>Interpolate secret<a class="headerlink" href="#interpolate-secret" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">text</span> <span class="o">=</span> <span class="n">Interpolate</span><span class="p">(</span><span class="s2">&quot;some text and %(secret:foo)s&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Secret keys are replaced in a string by the secret value using the class Interpolate and the keyword secret.
The secret is searched across the providers defined in the master configuration.</p>
</div>
<div class="section" id="secret-obfuscation">
<h2>Secret Obfuscation<a class="headerlink" href="#secret-obfuscation" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">text</span> <span class="o">=</span> <span class="n">Interpolate</span><span class="p">(</span><span class="s2">&quot;some text and %(secret:foo)s&quot;</span><span class="p">)</span>
<span class="c1"># some text rendered</span>
<span class="n">rendered</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<span class="n">cleantext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">build_status</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">cleanupTextFromSecrets</span><span class="p">(</span><span class="n">rendered</span><span class="p">)</span>
</pre></div>
</div>
<p>Secrets don’t have to be visible to the normal user via logs and thus are transmitted directly to the workers.
Secrets are rendered and can arrive anywhere in the logs.
The function <code class="docutils literal notranslate"><span class="pre">cleanupTextFromSecrets</span></code> defined in the class Properties helps to replace the secret value by the key value.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">print</span><span class="p">(</span><span class="s2">&quot;the example value is:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cleantext</span><span class="p">))</span>
<span class="o">&gt;&gt;</span> <span class="n">the</span> <span class="n">example</span> <span class="n">value</span> <span class="ow">is</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">foo</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Secret is rendered and it is recorded in a dictionary, named <code class="docutils literal notranslate"><span class="pre">_used_secrets</span></code>, where the key is the secret value and the value the secret key.
Therefore anywhere logs are written having content with secrets, the secrets are replaced by the value from <code class="docutils literal notranslate"><span class="pre">_used_secrets</span></code>.</p>
</div>
<div class="section" id="how-to-use-a-secret-in-a-buildbotservice">
<h2>How to use a secret in a BuildbotService<a class="headerlink" href="#how-to-use-a-secret-in-a-buildbotservice" title="Permalink to this headline">¶</a></h2>
<p>Service configurations are loaded during a Buildbot start or modified during a Buildbot restart.
Secrets are used like renderables in a service and are rendered during the configuration load.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyService</span><span class="p">(</span><span class="n">BuildbotService</span><span class="p">):</span>
  <span class="n">secrets</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;other&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">secrets</span></code> is a list containing all the secret keys that can be used as class attributes.
When the service is loaded during the Buildbot reconfigService function, secrets are rendered and the values are updated.
Everywhere the variable with the secret name (<cite>foo</cite> or <cite>other</cite> in the example) is used, the class attribute value is replaced by the secret value.
This is similar to the “renderable” annotation, but will only works for BuildbotServices, and will only interpolate secrets.
Others renderables can still be held in the service as attributes, and rendered dynamically at a later time.</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyService</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="n">secrets</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;other&#39;</span><span class="p">]</span>

<span class="n">myService</span> <span class="o">=</span> <span class="n">MyService</span><span class="p">()</span>
</pre></div>
</div>
</div></blockquote>
<p>After a Buildbot reconfigService:</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">print</span><span class="p">(</span><span class="s2">&quot;myService returns secret value:&quot;</span><span class="p">,</span> <span class="n">myService</span><span class="o">.</span><span class="n">foo</span><span class="p">))</span>
<span class="o">&gt;&gt;</span> <span class="n">myService</span> <span class="n">returns</span> <span class="n">secret</span> <span class="n">value</span> <span class="n">bar</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, junpengxu

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>